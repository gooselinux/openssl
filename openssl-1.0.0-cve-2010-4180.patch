Disable code workaround for ancient and obsolete Netscape browsers
and servers: an attacker can use it in a ciphersuite downgrade attack.
Thanks to Martin Rex for discovering this bug. CVE-2010-4180
Index: openssl/doc/ssl/SSL_CTX_set_options.pod
RCS File: /v/openssl/cvs/openssl/doc/ssl/SSL_CTX_set_options.pod,v
rcsdiff -q -kk '-r1.15.2.9' '-r1.15.2.10' -u '/v/openssl/cvs/openssl/doc/ssl/SSL_CTX_set_options.pod,v' 2>/dev/null
--- openssl/doc/ssl/SSL_CTX_set_options.pod 2010/02/18 12:41:50 1.15.2.9
+++ openssl/doc/ssl/SSL_CTX_set_options.pod 2010/12/02 18:24:54 1.15.2.10
@@ -78,18 +78,7 @@
 
 =item SSL_OP_NETSCAPE_REUSE_CIPHER_CHANGE_BUG
 
-ssl3.netscape.com:443, first a connection is established with RC4-MD5.
-If it is then resumed, we end up using DES-CBC3-SHA.  It should be
-RC4-MD5 according to 7.6.1.3, 'cipher_suite'.
-
-Netscape-Enterprise/2.01 (https://merchant.netscape.com) has this bug.
-It only really shows up when connecting via SSLv2/v3 then reconnecting
-via SSLv3. The cipher list changes....
-
-NEW INFORMATION.  Try connecting with a cipher list of just
-DES-CBC-SHA:RC4-MD5.  For some weird reason, each new connection uses
-RC4-MD5, but a re-connect tries to use DES-CBC-SHA.  So netscape, when
-doing a re-connect, always takes the first cipher in the cipher list.
+As of OpenSSL 0.9.8q and 1.0.0c, this option has no effect.
 
 =item SSL_OP_SSLREF2_REUSE_CERT_TYPE_BUG
 
Index: openssl/ssl/s3_clnt.c
RCS File: /v/openssl/cvs/openssl/ssl/s3_clnt.c,v
rcsdiff -q -kk '-r1.129.2.16' '-r1.129.2.17' -u '/v/openssl/cvs/openssl/ssl/s3_clnt.c,v' 2>/dev/null
--- openssl/ssl/s3_clnt.c 2010/10/10 12:33:10 1.129.2.16
+++ openssl/ssl/s3_clnt.c 2010/12/02 18:24:54 1.129.2.17
@@ -866,8 +866,11 @@
 		s->session->cipher_id = s->session->cipher->id;
 	if (s->hit && (s->session->cipher_id != c->id))
 		{
+/* Workaround is now obsolete */
+#if 0
 		if (!(s->options &
 			SSL_OP_NETSCAPE_REUSE_CIPHER_CHANGE_BUG))
+#endif
 			{
 			al=SSL_AD_ILLEGAL_PARAMETER;
 			SSLerr(SSL_F_SSL3_GET_SERVER_HELLO,SSL_R_OLD_SESSION_CIPHER_NOT_RETURNED);
Index: openssl/ssl/s3_srvr.c
RCS File: /v/openssl/cvs/openssl/ssl/s3_srvr.c,v
rcsdiff -q -kk '-r1.171.2.22' '-r1.171.2.23' -u '/v/openssl/cvs/openssl/ssl/s3_srvr.c,v' 2>/dev/null
--- openssl/ssl/s3_srvr.c 2010/11/14 13:50:29 1.171.2.22
+++ openssl/ssl/s3_srvr.c 2010/12/02 18:24:55 1.171.2.23
@@ -985,6 +985,10 @@
 				break;
 				}
 			}
+/* Disabled because it can be used in a ciphersuite downgrade
+ * attack: CVE-2010-4180.
+ */
+#if 0
 		if (j == 0 && (s->options & SSL_OP_NETSCAPE_REUSE_CIPHER_CHANGE_BUG) && (sk_SSL_CIPHER_num(ciphers) == 1))
 			{
 			/* Special case as client bug workaround: the previously used cipher may
@@ -999,6 +1003,7 @@
 				j = 1;
 				}
 			}
+#endif
 		if (j == 0)
 			{
 			/* we need to have the cipher in the cipher
